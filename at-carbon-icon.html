<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-meta/iron-meta.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="now-icons.html">


<dom-module id="at-carbon-icon">
  <style>
    :host {
      display: inline-flex;
      position: relative;
      fill: currentcolor;
      vertical-align: middle;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }
    div {
      display: block;
      position: relative;
    }
    svg {
      display: block;
      width: 24px;
      height: 24px;
    }
    img {
      width: 100%;
    }
  </style>
  <template>
    <iron-meta id="meta" type="iconset"></iron-meta>
    <content></content>
  </template>
</dom-module>

<script>
  (function () {
    var DEFAULT_ICONSET = 'now'

    Polymer({
      is: 'at-carbon-icon',
      _scopeCssViaAttr: true,
      properties: {
        src: {
          type: String,
          value: '',
          observer: 'srcChanged'
        },

        icon: {
          type: String,
          value: '',
          observer: 'updateIcon'
        },

        theme: {
          type: String,
          value: '',
          observer: 'updateIcon'
        },

        srcImgElement: {
          value: null
        },

        iconset: {
          value: ''
        }
      },

      get meta() {
        return this.$.meta;
      },

      get iconsetElement() {
        var iconsetElement;

        if (this.icon) {
          iconsetElement = this.meta.byKey(
            this.computeIconset(this.icon)
          );
        }

        return iconsetElement;
      },

      get iconName() {
        if (this.icon) {
          return this.icon.split(':').pop();
        }

        return '';
      },

      get usesSrcAttribute() {
        return !this.icon && this.src;
      },

      computeIconset: function (icon) {
        var iconset;

        if (icon && icon.indexOf(':') > -1) {
          iconset = icon.split(':').shift();
        }

        return iconset || DEFAULT_ICONSET;
      },

      updateIcon: function () {
        if (this.usesSrcAttribute) {
          return;
        }

        this.iconset = this.computeIconset(this.icon);
        if (this.iconsetElement) this.iconsetElement.applyIcon(this.root, this.iconName, this.theme);
      },

      srcChanged: function () {
        var currentIconChild;

        if (!this.usesSrcAttribute) {
          return;
        }

        if (currentIconChild = Polymer.dom(this.root).querySelector('div')) {
          Polymer.dom(this.root).removeChild(currentIconChild);
        }

        if (!this.srcImgElement) {
          this.srcImgElement = document.createElement('img');
        }

        this.srcImgElement.src = this.src;
        Polymer.dom(this.root).appendChild(this.srcImgElement);
      }
    });
  })();
</script>
