<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../iron-meta/iron-meta.html">
<link rel="import" href="now-icons.html">

<dom-module id="at-carbon-icon">

  <template>
    <style>
      :host {
        display: inline-block;
        position: relative;
        fill: currentcolor;
        vertical-align: middle;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
      }

      div {
        display: block;
        position: relative;
      }

      svg {
        display: block;
        width: 24px;
        height: 24px;
      }

      img {
        width: 100%;
      }
    </style>

    <content></content>
  </template>
</dom-module>

<script>
  (function() {
    "use strict";
    var DEFAULT_ICONSET = 'now'

    Polymer({
      is: 'at-carbon-icon',
      properties: {
        src: {
          type: String,
          value: '',
          observer: 'srcChanged'
        },
        icon: {
          type: String,
          value: '',
          observer: 'updateIcon'
        },
        theme: {
          type: String,
          value: '',
          observer: 'updateIcon'
        }
      },
      _meta: Polymer.Base.create('iron-meta', { type: 'iconset' }),
      srcImgElement: null,
      iconset: '',

      _getIconsetElement: function(icon) {
        var iconsetElement;

        if (icon) {
          iconsetElement = this._meta.byKey(
            this.computeIconset(icon)
          );
        }

        return iconsetElement;
      },

      _getIconName: function(icon) {
        if (icon) {
          return icon.split(':').pop();
        }

        return '';
      },

      get usesSrcAttribute() {
        return !this.icon && this.src;
      },

      computeIconset: function(icon) {
        var iconset;

        if (icon && icon.indexOf(':') > -1) {
          iconset = icon.split(':').shift();
        }

        return iconset || DEFAULT_ICONSET;
      },

      _isString: function(obj) {
        return Object.prototype.toString.apply(obj) === "[object String]";
      },

      updateIcon: function() {
        if (this.usesSrcAttribute) {
          return;
        }

        // compute iconVal as follows
        // if value of icon property is of type string, use that
        // else use initial value specified in properties of this element
        var iconVal = this._isString(this.icon) ? this.icon : this.properties.icon.value;

        this.iconset = this.computeIconset(iconVal);
        var iconsetElement = this._getIconsetElement(iconVal);

        if (iconsetElement) iconsetElement.applyIcon(this.root, this._getIconName(iconVal), this.theme);
      },

      srcChanged: function() {
        var currentIconChild;

        if (!this.usesSrcAttribute) {
          return;
        }

        if (currentIconChild = Polymer.dom(this.root).querySelector('div')) {
          Polymer.dom(this.root).removeChild(currentIconChild);
        }

        if (!this.srcImgElement) {
          this.srcImgElement = document.createElement('img');
        }

        this.srcImgElement.src = this.src;
        Polymer.dom(this.root).appendChild(this.srcImgElement);
      }
    });
  })();
</script>
